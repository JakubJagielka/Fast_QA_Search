<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Search Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a' }
                    }
                }
            }
        }
    </script>
    <style>
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0d9488; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; transform: scale(1); }
        .modal.opacity-0 .modal-content { transform: scale(0.95); } /* Add scale down for closing */
        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px;}
        .modal-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px;}
        .modal-body::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .modal-body { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; }
        mark { background-color: #a7f3d0; padding: 0.1em 0.2em; border-radius: 3px; }
        .keyword-badge { display: inline-block; background-color: #f3f4f6; color: #4b5563; padding: 1px 6px; border-radius: 9999px; font-size: 0.7rem; line-height: 1; margin-right: 4px; margin-bottom: 4px; white-space: nowrap; }
        .keyword-badge strong { font-weight: 500; margin-right: 3px; }
        /* Tab styles */
        .tab-button { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280; font-weight: 500; }
        .tab-button.active { color: #0d9488; border-bottom-color: #0d9488; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .search-result-card { transition: box-shadow 0.2s ease-in-out; }
        .search-result-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .chunk-container { max-height: 150px; overflow-y: auto; padding-right: 5px; } 
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <header class="bg-primary-700 text-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">Semantic Search Engine</h1>
                <p class="text-primary-200 text-sm">Hybrid search & QA for your documents</p>
            </div>
            <nav>
                <ul class="flex space-x-4">
                    <li><a href="#" class="hover:text-primary-200 transition text-sm" id="settingsBtn">Settings</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 mt-6">
        <div class="max-w-5xl mx-auto space-y-8">

            <div id="globalStatus" class="hidden p-3 rounded-md text-sm"></div>

            <div class="bg-white p-5 rounded-lg shadow">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Search Documents</h2>
                        <form id="searchForm" class="space-y-4">
                            <div class="flex">
                                <input type="text" name="query" placeholder="Enter search query..."
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                                <button type="submit" class="bg-primary-600 text-white px-5 py-2 rounded-r-md hover:bg-primary-700 transition flex items-center justify-center disabled:opacity-50">
                                    <span class="button-text">Search</span>
                                    <div class="spinner hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                                </button>
                            </div>
                            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm">
                                <div>
                                    <label class="block text-gray-600 mb-1 font-medium">Mode</label>
                                    <select name="mode" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 text-sm">
                                        <option value="hybrid" selected>Hybrid</option>
                                        <option value="semantic">Semantic</option>
                                        <option value="keyword">Keyword</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1 font-medium">Results</label>
                                    <select name="k" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 text-sm">
                                        <option value="3">3</option>
                                        <option value="5" selected>5</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Ask a Question</h2>
                        <form id="qaForm" class="space-y-4">
                            <div class="flex">
                                <input type="text" name="query" placeholder="Ask about your documents..."
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" required>
                                <button type="submit" class="bg-primary-600 text-white px-5 py-2 rounded-r-md hover:bg-primary-700 transition flex items-center justify-center disabled:opacity-50">
                                    <span class="button-text">Ask</span>
                                    <div class="spinner hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                                </button>
                            </div>
                            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm">
                                <div>
                                    <label class="block text-gray-600 mb-1 font-medium">Model</label>
                                    <select name="model" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 text-sm">
                                        <option value="gpt-4.1-mini" selected>GPT-4.1 Mini - balance model</option>
                                        <option value="gpt-4.1-nano">GPT-4.1 Nano - cheapest model</option>
                                        <option value="gpt-4.1">GPT-4.1 - best model</option>
                                        <option value="gpt-4o">GPT-4o (deprecated)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-600 mb-1 font-medium">Context (k)</label>
                                    <select name="k" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary-500 text-sm">
                                        <option value="2">2</option>
                                        <option value="3" selected>3</option>
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="30">30</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                        <div id="qaResult" class="mt-4 hidden">
                            <div class="p-4 border border-gray-200 rounded-md bg-gray-50 max-h-60 overflow-y-auto">
                                <h3 class="font-semibold text-gray-700 mb-2 text-sm">Answer:</h3>
                                <p id="qaAnswer" class="text-gray-800 whitespace-pre-wrap text-sm"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-center gap-4">
                 <button id="addSourceBtn" class="w-full sm:w-auto bg-primary-600 text-white px-6 py-2.5 rounded-md hover:bg-primary-700 transition text-base font-medium flex items-center justify-center shadow hover:shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    Add New Source
                </button>
                 <button id="manageSourcesBtn" class="w-full sm:w-auto bg-white text-gray-700 px-6 py-2.5 rounded-md hover:bg-gray-50 transition text-base font-medium flex items-center justify-center border border-gray-300 shadow hover:shadow-md">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                     </svg>
                    Manage Indexed Sources
                </button>
            </div>

            <div id="searchResultsContainer" class="bg-white p-5 rounded-lg shadow hidden">
                 <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-semibold text-gray-800">
                        Search Results for "<span id="resultsQuery" class="text-primary-600 font-bold"></span>"
                    </h2>
                    <span id="resultsCount" class="text-gray-600 text-sm font-medium"></span>
                </div>
                <div id="searchResults" class="space-y-6">
                </div>
                 <div id="noResults" class="text-center py-6 text-gray-500 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01" />
                    </svg>
                    No relevant results found. Try refining your search query.
                 </div>
            </div>

        </div>
    </main>

    <footer class="bg-gray-200 mt-12 py-4 border-t border-gray-300">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            Semantic Search Engine Â© 2024
        </div>
    </footer>

    <div id="settingsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-semibold text-gray-800">Search Settings</h2>
                <button id="closeSettingsBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="settingsForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2 font-medium">Hybrid Search Weights</label>
                    <div class="flex items-center space-x-4">
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600 mb-1">Semantic (<span id="semanticWeightValue" class="font-medium">0.5</span>)</label>
                            <input type="range" id="semanticWeight" name="semantic_weight" min="0" max="1" step="0.05" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary-600">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600 mb-1">Keyword (<span id="keywordWeightValue" class="font-medium">0.5</span>)</label>
                            <input type="range" id="keywordWeight" name="keyword_weight" min="0" max="1" step="0.05" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary-600">
                        </div>
                    </div>
                     <p class="text-xs text-gray-500 mt-1">Adjust the balance. Weights must sum to 1.</p>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition text-sm flex items-center justify-center disabled:opacity-50">
                        <span class="button-text">Save Settings</span>
                        <div class="spinner hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                    </button>
                </div>
                 <div id="settingsStatus" class="text-sm mt-2"></div>
            </form>
        </div>
    </div>

    <div id="viewContentModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl h-3/4 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="viewContentTitle" class="text-lg font-semibold text-gray-800 truncate">Document Content</h2>
                <button id="closeViewContentBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="viewContentBody" class="modal-body flex-grow p-4 overflow-y-auto text-sm text-gray-700 whitespace-pre-wrap bg-gray-50">
                Loading content...
            </div>
             <div class="p-2 text-xs text-center text-gray-500 border-t bg-gray-100">
                 Content loaded from source. Use <mark>highlighted text</mark> to find relevant chunks.
             </div>
        </div>
    </div>

    <div id="addSourceModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl p-0 w-full max-w-2xl">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Add New Source</h2>
                <button id="closeAddSourceBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="border-b border-gray-200">
                <nav class="flex space-x-1 px-4 -mb-px" aria-label="Tabs">
                    <button class="tab-button active" data-tab="upload">Upload Files</button>
                    <button class="tab-button" data-tab="text">Text Snippet</button>
                    <button class="tab-button" data-tab="url">Web Page (URL)</button>
                    <button class="tab-button" data-tab="domain">Crawl Domain</button>
                </nav>
            </div>
            <div class="modal-body p-6 max-h-[60vh] overflow-y-auto">
                <div id="tab-upload" class="tab-content active space-y-3">
                    <form id="uploadForm" class="space-y-3">
                        <input type="file" id="fileUpload" name="file" multiple
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 border border-gray-300 rounded-lg cursor-pointer focus:outline-none">
                        <button type="submit" class="w-full bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition text-sm flex items-center justify-center disabled:opacity-50">
                            <span class="button-text">Upload & Index</span>
                            <div class="spinner hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        </button>
                        <div class="text-xs text-gray-500">Max file size: 32MB. Supports: txt, md, pdf, docx, html.</div>
                    </form>
                     <div id="uploadStatus" class="text-sm mt-2"></div>
                </div>
                <div id="tab-text" class="tab-content space-y-3">
                    <form id="textForm" class="space-y-3">
                        <textarea name="text" placeholder="Paste text content here..." rows="5" required
                            class="w-full border border-gray-300 px-3 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"></textarea>
                        <button type="submit" class="w-full bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition text-sm flex items-center justify-center disabled:opacity-50">
                            <span class="button-text">Add Text & Index</span>
                            <div class="spinner hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        </button>
                    </form>
                    <div id="textStatus" class="text-sm mt-2"></div>
                </div>
                <div id="tab-url" class="tab-content space-y-3">
                    <form id="urlForm" class="space-y-3">
                        <input type="url" name="url" placeholder="https://example.com/page" required
                            class="w-full border border-gray-300 px-3 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        <button type="submit" class="w-full bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition text-sm flex items-center justify-center disabled:opacity-50">
                            <span class="button-text">Add URL & Index</span>
                            <div class="spinner hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        </button>
                    </form>
                    <div id="urlStatus" class="text-sm mt-2"></div>
                </div>
                <div id="tab-domain" class="tab-content space-y-3">
                    <form id="domainForm" class="space-y-3">
                        <input type="url" name="domain_url" placeholder="https://example.com" required
                            class="w-full border border-gray-300 px-3 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        <div class="flex items-center space-x-2 text-xs text-gray-600">
                            <label>
                                <input type="checkbox" name="save_to_disk" value="true" checked class="mr-1 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                Save crawled pages to disk
                            </label>
                            <label>
                                Max pages:
                                <input type="number" name="max_pages" min="1" max="100000" value="20" class="w-14 border border-gray-300 rounded px-1 py-0.5 ml-1">
                            </label>
                        </div>
                        <button type="submit" class="w-full bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition text-sm flex items-center justify-center disabled:opacity-50">
                            <span class="button-text">Crawl Domain & Index</span>
                            <div class="spinner hidden ml-2" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        </button>
                    </form>
                    <div id="domainStatus" class="text-sm mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="manageSourcesModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl h-3/4 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Manage Indexed Sources</h2>
                 <div class="flex items-center space-x-3">
                     <button id="refreshSourcesBtnModal" class="text-primary-600 hover:text-primary-800 text-sm font-medium flex items-center disabled:opacity-50 p-1 rounded hover:bg-primary-50" title="Refresh sources list">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.418 0a8.003 8.003 0 01-15.357-2m15.357 2H15M4 12v5h-.581m15.357-2a8.001 8.001 0 01-15.357 2m15.357-2H9" />
                        </svg>
                        <span class="button-text">Refresh</span>
                        <div class="spinner hidden ml-1" style="width: 14px; height: 14px; border-width: 2px;"></div>
                    </button>
                    <button id="deleteAllSourcesBtn" class="text-red-600 hover:text-red-800 text-sm font-medium flex items-center disabled:opacity-50 p-1 rounded hover:bg-red-100" title="Delete ALL indexed sources. This cannot be undone!">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span class="button-text">Delete All</span>
                        <div class="spinner hidden ml-1" style="width: 14px; height: 14px; border-width: 2px; border-left-color: #dc2626;"></div> <!-- Red spinner -->
                    </button>
                    <button id="closeManageSourcesBtn" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                 </div>
            </div>
            <div class="modal-body flex-grow p-4 overflow-y-auto bg-gray-50">
                <div id="sourcesLoadingModal" class="text-center py-4 text-gray-500">Loading sources...</div>
                <ul id="sourcesListModal" class="space-y-2">
                </ul>
            </div>
             <div class="p-2 text-xs text-center text-gray-500 border-t bg-gray-100">
                 View or delete indexed documents. Use 'Delete All' with extreme caution.
             </div>
        </div>
    </div>


    <script>
        const API_BASE = '/api';
        let currentSources = [];
        let sourcesLoaded = false; 

        const searchForm = document.getElementById('searchForm');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const searchResultsDiv = document.getElementById('searchResults');
        const resultsQuerySpan = document.getElementById('resultsQuery');
        const resultsCountSpan = document.getElementById('resultsCount');
        const noResultsDiv = document.getElementById('noResults');

        const qaForm = document.getElementById('qaForm');
        const qaResultDiv = document.getElementById('qaResult');
        const qaAnswerP = document.getElementById('qaAnswer');

        const addSourceBtn = document.getElementById('addSourceBtn');
        const addSourceModal = document.getElementById('addSourceModal');
        const closeAddSourceBtn = document.getElementById('closeAddSourceBtn');
        const addSourceTabs = addSourceModal.querySelectorAll('.tab-button');
        const addSourceTabContents = addSourceModal.querySelectorAll('.tab-content');
        const uploadForm = document.getElementById('uploadForm');
        const fileUploadInput = document.getElementById('fileUpload');
        const uploadStatusDiv = document.getElementById('uploadStatus');
        const textForm = document.getElementById('textForm');
        const textStatusDiv = document.getElementById('textStatus');
        const urlForm = document.getElementById('urlForm');
        const urlStatusDiv = document.getElementById('urlStatus');
        const domainForm = document.getElementById('domainForm');
        const domainStatusDiv = document.getElementById('domainStatus');

        const manageSourcesBtn = document.getElementById('manageSourcesBtn');
        const manageSourcesModal = document.getElementById('manageSourcesModal');
        const closeManageSourcesBtn = document.getElementById('closeManageSourcesBtn');
        const sourcesListUlModal = document.getElementById('sourcesListModal');
        const sourcesLoadingDivModal = document.getElementById('sourcesLoadingModal');
        const refreshSourcesBtnModal = document.getElementById('refreshSourcesBtnModal');
        const deleteAllSourcesBtn = document.getElementById('deleteAllSourcesBtn'); // <-- New button reference

        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const settingsForm = document.getElementById('settingsForm');
        const semanticWeightSlider = document.getElementById('semanticWeight');
        const keywordWeightSlider = document.getElementById('keywordWeight');
        const semanticWeightValueSpan = document.getElementById('semanticWeightValue');
        const keywordWeightValueSpan = document.getElementById('keywordWeightValue');
        const settingsStatusDiv = document.getElementById('settingsStatus');

        const viewContentModal = document.getElementById('viewContentModal');
        const viewContentTitle = document.getElementById('viewContentTitle');
        const viewContentBody = document.getElementById('viewContentBody');
        const closeViewContentBtn = document.getElementById('closeViewContentBtn');

        const globalStatusDiv = document.getElementById('globalStatus');

        function showStatus(element, message, isError = false, duration = 5000) {
            if (!element) return;
            element.textContent = message;
            element.className = `text-sm mt-2 p-2 rounded ${isError ? 'text-red-700 bg-red-100' : 'text-green-700 bg-green-100'}`;
            element.classList.remove('hidden');
            if (duration > 0) {
                setTimeout(() => {
                    element.classList.add('hidden');
                    element.textContent = '';
                }, duration);
            }
        }

        function showGlobalStatus(message, isError = false, duration = 5000) {
             showStatus(globalStatusDiv, message, isError, duration);
             if (isError || !duration || duration === 0) globalStatusDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function toggleButtonLoading(button, isLoading) {
            const textSpan = button.querySelector('.button-text');
            const spinner = button.querySelector('.spinner');
            if (isLoading) {
                button.disabled = true;
                if (textSpan) textSpan.style.display = 'none';
                if (spinner) spinner.style.display = 'inline-block';
            } else {
                button.disabled = false;
                if (textSpan) textSpan.style.display = 'inline-block';
                if (spinner) spinner.style.display = 'none';
            }
        }

        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; 
            setTimeout(() => {
                modalElement.classList.remove('opacity-0', 'pointer-events-none');
            }, 10); 
        }

        function closeModal(modalElement) {
            modalElement.classList.add('opacity-0');
            document.body.style.overflow = ''; 
            setTimeout(() => {
                modalElement.classList.add('hidden', 'pointer-events-none');
            }, 250); 
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getFileTypeIcon(type) {
             switch(type?.toLowerCase()) { 
                 case 'file': return `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>`;
                 case 'text': return `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;
                 case 'url': return `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>`;
                 case 'domain': return `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>`;
                 default: return `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
             }
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        async function fetchApi(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            try {
                const response = await fetch(url, options);
                let data = {};
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await response.json();
                } else if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP error! status: ${response.status}`);
                }

                if (!response.ok) {
                    throw new Error(data.error || data.message || `HTTP error! status: ${response.status}`);
                }
                return data; 
            } catch (error) {
                console.error(`API Error (${url}):`, error);
                if (!options.skipGlobalError) {
                    showGlobalStatus(`Error communicating with server: ${error.message}`, true);
                }
                throw error; 
            }
        }

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(searchForm);
            const query = formData.get('query');
            const button = searchForm.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            searchResultsContainer.classList.add('hidden');
            searchResultsDiv.innerHTML = '';
            noResultsDiv.classList.add('hidden');
            qaResultDiv.classList.add('hidden'); 

            try {
                const data = await fetchApi('/search', { method: 'POST', body: formData, skipGlobalError: true });
                resultsQuerySpan.textContent = query;
                resultsCountSpan.textContent = `${data.results.length} results found`;
                renderSearchResults(data.results);
                searchResultsContainer.classList.remove('hidden');
                searchResultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                 showGlobalStatus(`Search failed: ${error.message}`, true);
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        qaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(qaForm);
            const button = qaForm.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            qaResultDiv.classList.remove('hidden');
            qaAnswerP.textContent = 'Processing your question...';
            qaAnswerP.className = 'text-gray-500 whitespace-pre-wrap text-sm italic'; 
            searchResultsContainer.classList.add('hidden'); 

            try {
                const data = await fetchApi('/qa', { method: 'POST', body: formData, skipGlobalError: true });
                qaAnswerP.textContent = data.answer;
                qaAnswerP.className = 'text-gray-800 whitespace-pre-wrap text-sm'; 
                qaResultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (error) {
                qaAnswerP.textContent = `Error: ${error.message}`;
                qaAnswerP.className = 'text-red-600 whitespace-pre-wrap text-sm'; 
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        addSourceBtn.addEventListener('click', () => openModal(addSourceModal));
        closeAddSourceBtn.addEventListener('click', () => closeModal(addSourceModal));
        addSourceModal.addEventListener('click', (e) => { if (e.target === addSourceModal) closeModal(addSourceModal); });

        addSourceTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                addSourceTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                addSourceTabContents.forEach(content => {
                    if (content.id === `tab-${targetTab}`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
                
                [uploadStatusDiv, textStatusDiv, urlStatusDiv, domainStatusDiv].forEach(div => {
                    div.classList.add('hidden');
                    div.textContent = '';
                });
            });
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            const files = fileUploadInput.files;
            if (files.length === 0) {
                showStatus(uploadStatusDiv, 'Please select one or more files to upload.', true);
                return;
            }
            for (const file of files) {
                formData.append('file', file);
            }

            const button = uploadForm.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            uploadStatusDiv.classList.add('hidden');

            try {
                const data = await fetchApi('/upload', { method: 'POST', body: formData, skipGlobalError: true });
                let message = `Successfully processed: ${data.processed.join(', ')}.`;
                let isError = false;
                if (data.errors && data.errors.length > 0) {
                    message += `\nErrors: ${data.errors.join(', ')}`;
                    isError = true;
                }
                showStatus(uploadStatusDiv, message, isError, isError ? 0 : 5000);
                if (!isError) {
                     uploadForm.reset();
                     sourcesLoaded = false; 
                     showGlobalStatus("File(s) indexed successfully.", false, 3000); 
                } else {
                    showGlobalStatus("Some files could not be processed.", true, 5000);
                }
            } catch (error) {
                 showStatus(uploadStatusDiv, `Upload failed: ${error.message}`, true, 0);
                 showGlobalStatus(`Upload failed: ${error.message}`, true);
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        textForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(textForm);
            const button = textForm.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            textStatusDiv.classList.add('hidden');

            try {
                const data = await fetchApi('/add_text', { method: 'POST', body: formData, skipGlobalError: true });
                showStatus(textStatusDiv, data.message || 'Text added successfully!', false);
                textForm.reset();
                sourcesLoaded = false;
                showGlobalStatus("Text snippet indexed successfully.", false, 3000);
            } catch (error) {
                 showStatus(textStatusDiv, `Error adding text: ${error.message}`, true);
                 showGlobalStatus(`Failed to index text: ${error.message}`, true);
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        urlForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(urlForm);
            const button = urlForm.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            urlStatusDiv.classList.add('hidden');

            try {
                const data = await fetchApi('/add_url', { method: 'POST', body: formData, skipGlobalError: true });
                 showStatus(urlStatusDiv, data.message || 'URL added successfully!', false);
                urlForm.reset();
                sourcesLoaded = false; 
                showGlobalStatus("URL indexed successfully.", false, 3000);
            } catch (error) {
                 showStatus(urlStatusDiv, `Error adding URL: ${error.message}`, true);
                 showGlobalStatus(`Failed to index URL: ${error.message}`, true);
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        domainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(domainForm);
            if (!formData.has('save_to_disk')) formData.append('save_to_disk', 'false');
            const button = domainForm.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            domainStatusDiv.classList.add('hidden');

            try {
                const data = await fetchApi('/add_domain', { method: 'POST', body: formData, skipGlobalError: true });
                showStatus(domainStatusDiv, data.message || 'Domain crawl initiated! This may take time.', false, 0); 
                domainForm.reset();
                sourcesLoaded = false; 
                showGlobalStatus(data.message || 'Domain crawl started.', false, 5000);
            } catch (error) {
                showStatus(domainStatusDiv, `Error crawling domain: ${error.message}`, true, 0);
                 showGlobalStatus(`Failed to start domain crawl: ${error.message}`, true);
            } finally {
                toggleButtonLoading(button, false);
            }
        });


        manageSourcesBtn.addEventListener('click', () => {
            openModal(manageSourcesModal);
            if (!sourcesLoaded) {
                fetchSources(true); 
            }
        });
        closeManageSourcesBtn.addEventListener('click', () => closeModal(manageSourcesModal));
        manageSourcesModal.addEventListener('click', (e) => { if (e.target === manageSourcesModal) closeModal(manageSourcesModal); });
        refreshSourcesBtnModal.addEventListener('click', () => fetchSources(true)); // Force refresh
        deleteAllSourcesBtn.addEventListener('click', handleDeleteAllSources); // <-- Add listener for new button


        async function fetchSources(forceRefresh = false) {
            if (!forceRefresh && sourcesLoaded) return;

            toggleButtonLoading(refreshSourcesBtnModal, true);
            deleteAllSourcesBtn.disabled = true; 
            sourcesLoadingDivModal.classList.remove('hidden');
            sourcesLoadingDivModal.textContent = 'Loading sources...';
            sourcesLoadingDivModal.classList.remove('text-red-600');
            sourcesListUlModal.innerHTML = '';

            try {
                const data = await fetchApi('/sources', { skipGlobalError: true });
                currentSources = data.sources || [];
                renderSourcesList(currentSources);
                sourcesLoadingDivModal.classList.add('hidden');
                sourcesLoaded = true; 
            } catch (error) {
                 sourcesLoadingDivModal.textContent = 'Error loading sources.';
                 sourcesLoadingDivModal.classList.add('text-red-600');
                 sourcesLoaded = false; 
                 showGlobalStatus(`Failed to load sources: ${error.message}`, true); 
            } finally {
                 toggleButtonLoading(refreshSourcesBtnModal, false);
                 deleteAllSourcesBtn.disabled = !sourcesLoaded && sourcesListUlModal.innerHTML.includes('No sources indexed');
            }
        }

        function renderSourcesList(sources) {
            sourcesListUlModal.innerHTML = ''; 
            if (sources.length === 0) {
                sourcesListUlModal.innerHTML = '<li class="text-center text-gray-500 py-4">No sources indexed yet.</li>';
                deleteAllSourcesBtn.disabled = true; 
                return;
            }

            deleteAllSourcesBtn.disabled = false; 

            sources.forEach(source => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2.5 border border-gray-200 rounded-md bg-white hover:bg-gray-50 text-sm transition duration-150 ease-in-out';
                li.dataset.docId = source.doc_id;

                const displayPath = source.file_path.length > 60 ? `...${source.file_path.slice(-57)}` : source.file_path;
                const displayId = source.doc_id.length > 15 ? `${source.doc_id.substring(0, 12)}...` : source.doc_id;

                li.innerHTML = `
                    <div class="flex items-center space-x-3 overflow-hidden mr-2">
                         <span class="flex-shrink-0 pt-px" title="Type: ${escapeHtml(source.type || 'N/A')}">${getFileTypeIcon(source.type)}</span>
                         <div class="overflow-hidden">
                            <span class="font-medium text-gray-800 block truncate" title="${escapeHtml(source.file_path)}">${escapeHtml(displayPath)}</span>
                            <span class="text-xs text-gray-500 block truncate" title="ID: ${escapeHtml(source.doc_id)} | Size: ${formatFileSize(source.file_size || 0)} | Chunks: ${source.chunk_count || 0}">
                                ID: ${escapeHtml(displayId)} | Size: ${formatFileSize(source.file_size || 0)} | Chunks: ${source.chunk_count || 0}
                            </span>
                         </div>
                    </div>
                    <div class="flex space-x-1 sm:space-x-2 flex-shrink-0">
                        <button class="view-content-btn text-blue-600 hover:text-blue-800 text-xs font-medium p-1 rounded hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-300" title="View Content">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        </button>
                        <button class="delete-source-btn text-red-600 hover:text-red-800 text-xs font-medium p-1 rounded hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-300" title="Delete Source">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;

                li.querySelector('.view-content-btn').addEventListener('click', () => handleViewContent(source.doc_id, source.file_path));
                li.querySelector('.delete-source-btn').addEventListener('click', () => handleDeleteSource(source.doc_id, source.file_path));

                sourcesListUlModal.appendChild(li);
            });
        }

        async function handleDeleteSource(docId, filePath) {
            if (!confirm(`Are you sure you want to delete the source "${filePath}" (ID: ${docId})?\nThis will remove it from the search index.`)) {
                return;
            }

            const listItem = sourcesListUlModal.querySelector(`li[data-doc-id="${docId}"]`);
            if (listItem) {
                 listItem.style.opacity = '0.5';
                 listItem.querySelectorAll('button').forEach(btn => btn.disabled = true);
            }

            try {
                await fetchApi(`/source/${docId}/delete`, { method: 'DELETE', skipGlobalError: true });
                showGlobalStatus(`Source "${filePath}" deleted successfully.`, false, 4000);
                if (listItem) {
                    listItem.remove();
                    currentSources = currentSources.filter(s => s.doc_id !== docId);
                     if (sourcesListUlModal.children.length === 0 || (sourcesListUlModal.children.length === 1 && sourcesListUlModal.children[0].tagName === 'LI' && sourcesListUlModal.children[0].textContent.includes('No sources'))) {
                         renderSourcesList([]); 
                     } else {
                         deleteAllSourcesBtn.disabled = false;
                     }
                } else {
                    fetchSources(true); 
                }
            } catch (error) {
                showGlobalStatus(`Error deleting source "${filePath}": ${error.message}`, true);
                 if (listItem) {
                     listItem.style.opacity = '1';
                     listItem.querySelectorAll('button').forEach(btn => btn.disabled = false);
                 }
            }
        }

        async function handleDeleteAllSources() {
            if (!confirm("ð¨ WARNING! ð¨\n\nAre you absolutely sure you want to delete ALL indexed sources?\n\nThis action is irreversible and will clear the entire search index.")) {
                return;
            }

            const button = deleteAllSourcesBtn;
            toggleButtonLoading(button, true);
            refreshSourcesBtnModal.disabled = true; 

            sourcesLoadingDivModal.textContent = 'Deleting all sources... This may take a moment.';
            sourcesLoadingDivModal.classList.remove('hidden', 'text-red-600');
            sourcesListUlModal.innerHTML = ''; 

            try {
                const data = await fetchApi('/source/delete_all', {
                    method: 'DELETE',
                    skipGlobalError: true 
                });

                showGlobalStatus(data.message || 'All sources deleted successfully.', false, 5000);
                fetchSources(true); 
                sourcesLoaded = false;

            } catch (error) {
                showGlobalStatus(`Error deleting all sources: ${error.message}`, true);
                sourcesLoadingDivModal.textContent = 'Failed to delete all sources. Please try refreshing the list.';
                sourcesLoadingDivModal.classList.add('text-red-600');
                fetchSources(true);
            } finally {
                 toggleButtonLoading(button, false); 
                 refreshSourcesBtnModal.disabled = false; 
            }
        }

        settingsBtn.addEventListener('click', (e) => { e.preventDefault(); openModal(settingsModal); });
        closeSettingsBtn.addEventListener('click', () => closeModal(settingsModal));
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeModal(settingsModal); });

        function syncWeights(changedSlider) {
            const semanticVal = parseFloat(semanticWeightSlider.value);
            const keywordVal = parseFloat(keywordWeightSlider.value);

            if (changedSlider === semanticWeightSlider) {
                keywordWeightSlider.value = (1 - semanticVal).toFixed(2);
            } else {
                semanticWeightSlider.value = (1 - keywordVal).toFixed(2);
            }
            semanticWeightValueSpan.textContent = semanticWeightSlider.value;
            keywordWeightValueSpan.textContent = keywordWeightSlider.value;
        }
        semanticWeightSlider.addEventListener('input', () => syncWeights(semanticWeightSlider));
        keywordWeightSlider.addEventListener('input', () => syncWeights(keywordWeightSlider));

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(settingsForm);
            const button = settingsForm.querySelector('button[type="submit"]');
            toggleButtonLoading(button, true);
            settingsStatusDiv.classList.add('hidden');

            try {
                const data = await fetchApi('/settings/weights', { method: 'POST', body: formData, skipGlobalError: true });
                showStatus(settingsStatusDiv, data.message || 'Settings saved!', false);
                setTimeout(() => closeModal(settingsModal), 1500);
            } catch (error) {
                 showStatus(settingsStatusDiv, `Error saving settings: ${error.message}`, true);
            } finally {
                toggleButtonLoading(button, false);
            }
        });

        closeViewContentBtn.addEventListener('click', () => closeModal(viewContentModal));
        viewContentModal.addEventListener('click', (e) => { if (e.target === viewContentModal) closeModal(viewContentModal); });

        async function handleViewContent(docId, filePath) {
            viewContentTitle.textContent = `Content: ${escapeHtml(filePath)}`;
            viewContentBody.innerHTML = '<div class="text-center p-4 text-gray-500">Loading content...</div>';
            viewContentBody.scrollTop = 0;
            openModal(viewContentModal);

            try {
                const data = await fetchApi(`/source/${docId}/content`, { skipGlobalError: true });
                viewContentBody.textContent = data.content || '(No content returned or content is empty)';
                viewContentBody.className = 'modal-body flex-grow p-4 overflow-y-auto text-sm text-gray-700 whitespace-pre-wrap bg-gray-50'; // Reset class
            } catch (error) {
                viewContentBody.textContent = `Error loading content: ${error.message}`;
                viewContentBody.className = 'modal-body flex-grow p-4 overflow-y-auto text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 text-red-600'; // Add error color
            }
        }

        async function handleOpenFileFromSearch(docId, filePath, chunksToHighlight) {
            viewContentTitle.textContent = `Content: ${escapeHtml(filePath)}`;
            viewContentBody.innerHTML = '<div class="text-center p-4 text-gray-500">Loading and highlighting content...</div>';
            viewContentBody.scrollTop = 0;
            openModal(viewContentModal);

            try {
                const data = await fetchApi(`/source/${docId}/content`, { skipGlobalError: true });
                let fullContent = data.content || '(No content returned)';

                if (fullContent && chunksToHighlight && chunksToHighlight.length > 0) {
                    const sortedChunks = [...chunksToHighlight].sort((a, b) => b.length - a.length);
                    let highlightedContent = escapeHtml(fullContent); // Escape original content first

                    sortedChunks.forEach(chunkText => {
                        if (chunkText && chunkText.trim() !== '') {
                            try {
                                const escapedChunkForRegex = escapeRegExp(chunkText);
                                const regex = new RegExp(`(?<!<[^>]*)${escapedChunkForRegex}(?![^<]*>)`, 'g');
                                highlightedContent = highlightedContent.replace(regex, (match) => `<mark>${match}</mark>`);

                            } catch (regexError) {
                                console.error(`Regex error highlighting chunk: ${regexError}. Chunk: ${chunkText.substring(0,50)}...`);
                                const escapedChunkHtml = escapeHtml(chunkText);
                                highlightedContent = highlightedContent.replace(escapedChunkHtml, `<mark>${escapedChunkHtml}</mark>`);
                            }
                        }
                    });
                    viewContentBody.innerHTML = highlightedContent;
                    viewContentBody.className = 'modal-body flex-grow p-4 overflow-y-auto text-sm text-gray-700 whitespace-pre-wrap bg-gray-50'; // Reset class

                    const firstHighlight = viewContentBody.querySelector('mark');
                    if (firstHighlight) {
                        setTimeout(() => {
                             firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 150); 
                    }

                } else {
                    viewContentBody.textContent = fullContent;
                    viewContentBody.className = 'modal-body flex-grow p-4 overflow-y-auto text-sm text-gray-700 whitespace-pre-wrap bg-gray-50'; // Reset class
                }

            } catch (error) {
                viewContentBody.textContent = `Error loading or highlighting content: ${error.message}`;
                viewContentBody.className = 'modal-body flex-grow p-4 overflow-y-auto text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 text-red-600'; // Add error color
            }
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return ''; 
            return unsafe
                 .replace(/&/g, "&") 
                 .replace(/</g, "<")  
                 .replace(/>/g, ">")  
                 .replace(/"/g, "\"") 
                 .replace(/'/g, "'"); 
        }

        function unicodeBase64Encode(str) {
            try {
                const bytes = new TextEncoder().encode(str);
                let binaryString = '';
                bytes.forEach(byte => {
                    binaryString += String.fromCharCode(byte);
                });
                return btoa(binaryString);
            } catch (e) {
                console.error("Error during Base64 encoding:", e, "String:", str.substring(0, 100) + "...");
                return ''; 
            }
        }

        function unicodeBase64Decode(base64Str) {
            try {
                const binaryString = atob(base64Str);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return new TextDecoder().decode(bytes);
            } catch (e) {
                console.error("Error during Base64 decoding:", e, "Base64:", base64Str);
                try {
                    return decodeURIComponent(escape(atob(base64Str)));
                } catch (fallbackError) {
                     console.error("Legacy Base64 decoding also failed:", fallbackError);
                     return ''; 
                }
            }
        }

        function renderSearchResults(results) {
            searchResultsDiv.innerHTML = '';
            if (!results || results.length === 0) {
                noResultsDiv.classList.remove('hidden');
                return;
            }

            noResultsDiv.classList.add('hidden');
            results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'border border-gray-200 p-4 rounded-lg bg-white space-y-3 shadow-sm search-result-card';

                const chunksData = result.chunk_text || [];
                const encodedChunks = unicodeBase64Encode(JSON.stringify(chunksData));

                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex justify-between items-start gap-3 pb-2 border-b border-gray-100';

                const displayFileName = result.file_path || result.file_name || 'Unknown Source';

                headerDiv.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <h3 class="text-lg font-semibold text-gray-800 break-words inline" title="${escapeHtml(displayFileName)}">${escapeHtml(displayFileName)}</h3>
                        <span class="text-xs text-gray-500 ml-1">(ID: ${result.doc_id || 'N/A'})</span>
                    </div>
                    <button class="open-highlight-btn flex-shrink-0 bg-primary-50 text-primary-700 hover:bg-primary-100 text-xs font-medium py-1 px-2.5 rounded-full inline-flex items-center transition duration-150 ease-in-out"
                            title="Open file and highlight relevant chunks"
                            data-doc-id="${result.doc_id}"
                            data-file-path="${escapeHtml(displayFileName)}"
                            data-chunks-encoded="${encodedChunks}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        View & Highlight
                    </button>
                `;
                resultEl.appendChild(headerDiv);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex flex-wrap items-center gap-x-3 gap-y-1 pt-2';
                infoDiv.innerHTML = `
                    <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full font-medium" title="Combined Score">Score: ${result.combined_score?.toFixed(3) ?? 'N/A'}</span>
                    <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full font-medium" title="BM25 Score (Keyword)">K: ${result.bm25_score?.toFixed(3) ?? 'N/A'}</span>
                    <span class="px-2 py-0.5 bg-purple-100 text-purple-800 text-xs rounded-full font-medium" title="Semantic Score">S: ${result.semantic_score?.toFixed(3) ?? 'N/A'}</span>
                    ${result.all_terms_present ? `<span class="px-2 py-0.5 bg-teal-100 text-teal-800 text-xs rounded-full font-medium flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>All Terms</span>` : ''}
                `;
                resultEl.appendChild(infoDiv);

                if (result.chunk_text && result.chunk_text.length > 0) {
                    const chunksDiv = document.createElement('div');
                    chunksDiv.className = 'pt-3';
                    chunksDiv.innerHTML = `
                        <h4 class="font-medium text-gray-600 mb-1.5 text-xs uppercase tracking-wider">Relevant Chunks (${result.chunk_text.length}):</h4>
                        <div class="space-y-2 chunk-container border border-gray-100 rounded p-2 bg-gray-50">
                            ${result.chunk_text.map((chunk, index) => `
                                <div class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">
                                    <p>${escapeHtml(chunk)}</p>
                                    <span class="text-gray-500 text-xs block mt-1">(Chunk ID: ${result.chunk_id?.[index] || 'N/A'})</span>
                                </div>
                            `).join('<hr class="border-gray-200 my-1.5">')}
                        </div>
                    `;
                    resultEl.appendChild(chunksDiv);
                } else if (result.mode !== 'keyword') { 
                     const noChunksDiv = document.createElement('div');
                     noChunksDiv.className = 'text-xs text-gray-500 italic pt-2';
                     noChunksDiv.textContent = 'No specific relevant chunks identified by semantic search.';
                     resultEl.appendChild(noChunksDiv);
                }

                if (Object.keys(result.positions || {}).length > 0) {
                    const keywordsDiv = document.createElement('div');
                    keywordsDiv.className = 'pt-3 border-t border-gray-100 mt-3';
                    keywordsDiv.innerHTML = `
                        <h4 class="font-medium text-gray-600 mb-1.5 text-xs uppercase tracking-wider">Keyword Positions:</h4>
                        <div>
                            ${Object.entries(result.positions || {}).map(([token, info]) => `
                                <span class="keyword-badge">
                                    <strong>${escapeHtml(token)}:</strong> ${info.positions ? info.positions.join(', ') : 'N/A'}
                                </span>
                            `).join('')}
                        </div>
                    `;
                    resultEl.appendChild(keywordsDiv);
                }

                const highlightButton = resultEl.querySelector('.open-highlight-btn');
                if(highlightButton) {
                    highlightButton.addEventListener('click', (e) => {
                        const button = e.currentTarget;
                        const docId = button.dataset.docId;
                        const filePath = button.dataset.filePath;
                        let chunksToHighlight = [];
                        try {
                            const decodedJsonString = unicodeBase64Decode(button.dataset.chunksEncoded);
                            if (decodedJsonString) {
                                chunksToHighlight = JSON.parse(decodedJsonString);
                            } else {
                                console.warn("Decoded chunk data is empty.");
                            }
                        } catch (parseError) {
                            console.error("Error parsing decoded chunk data:", parseError, "Encoded:", button.dataset.chunksEncoded);
                            showGlobalStatus("Could not parse highlighting data.", true);
                        }
                        if (docId && docId !== 'undefined' && docId !== 'null') {
                             handleOpenFileFromSearch(docId, filePath, chunksToHighlight);
                        } else {
                            console.error("Invalid docId for highlighting:", docId);
                             showGlobalStatus("Cannot open file: Invalid document ID.", true);
                        }
                    });
                } else {
                    console.warn("Highlight button not found for result:", result);
                }

                searchResultsDiv.appendChild(resultEl);
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            sourcesLoadingDivModal.textContent = 'Click "Manage Indexed Sources" to load the list.';
            document.querySelectorAll('.spinner').forEach(spinner => spinner.style.display = 'none');
            deleteAllSourcesBtn.disabled = true;
        });

    </script>
</body>
</html>